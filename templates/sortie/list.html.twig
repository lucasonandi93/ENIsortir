{% extends 'base.html.twig' %}


{% block header %}
    <link rel="stylesheet" href="{{ asset('assets/css/styleList.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/containerPrinc.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/normalize.css') }}">
{% endblock %}

{% block title %}
    {{ parent() }} | Liste des sorties
{% endblock %}

{% block body %}

    <div class="containerPrinc">
        <div class="form-container">

            {{ form_start(filtre) }}
            <div class="form1">
                <div id="title_filtre"><p>Recherche Personnalisée</p></div>
                <div class="form1-filtres">
                    <div class="dateCampus">
                        <div class="containerCampus">
                            {{ form_label(filtre.campus) }}
                            {{ form_widget(filtre.campus) }}
                        </div>
                        <div class="containerDate">
                            {{ form_label(filtre.nom) }}
                            {{ form_widget(filtre.nom) }}

                            {# {{ form_label(filtre.dateSortie) }} #}
                            {{ form_row(filtre.dateSortie) }}

                            {{ form_label(filtre.dateCloture) }}
                            {{ form_widget(filtre.dateCloture) }}
                        </div>
                    </div>
                    <div class="containerFiltre">
                        <div class="checkboxFiltre">
                            <div class="margR">
                                {{ form_widget(filtre.sortieOrganisateur) }}
                            </div>
                            {{ form_label(filtre.sortieOrganisateur) }}
                        </div>
                        <div class="checkboxFiltre">
                            <div class="margR">
                                {{ form_widget(filtre.sortieInscrit) }}
                            </div>
                            {{ form_label(filtre.sortieInscrit) }}
                        </div>
                        <div class="checkboxFiltre">
                            <div class="margR">
                                {{ form_widget(filtre.sortiePasInscrit) }}
                            </div>
                            {{ form_label(filtre.sortiePasInscrit) }}
                        </div>
                        <div class="checkboxFiltre">
                            <div class="margR">
                                {{ form_widget(filtre.sortiePasses) }}
                            </div>
                            {{ form_label(filtre.sortiePasses) }}
                        </div>
                    </div>
                </div>
                <button>Rechercher</button>
            </div>
            {{ form_end(filtre) }}

            <div class="liste_sortir">
                <div class="titre_list">
                    <h1>Liste des sorties</h1>
                </div>

                <div>
                    {% for label, messages in app.session.flashbag.all() %}
                        {% for message in messages %}
                            <div class="alert alert-{{ label }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
                <div class="table-responsive">
                    <table id="table_sortir" class="table table-striped table-hover table-gradient table-wrapper">
                        <thead>
                        <tr>
                            <th scope="col" data-sort="nom">Nom de la sortie</th>
                            <th scope="col" data-sort="date">Date de la sortie</th>
                            <th scope="col" data-sort="cloture">Clôture des inscriptions</th>
                            <th scope="col" data-sort="inscris_numero">Inscrits/places totales</th>
                            <th scope="col" data-sort="etat">Etat</th>
                            <th scope="col" data-sort="inscrit">Inscrit</th>
                            <th scope="col" data-sort="organisateur">Organisateur</th>
                            <th scope="col">Actions</th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for sortie in sortieFiltre %}
                            <tr data-index="{{ loop.index }}">
                                <th scope="row"><a
                                            href="{{ path('sortie_details', {'id': sortie.id }) }}">{{ sortie.nom|capitalize }}</a>
                                </th>
                                <td>{{ sortie.dateHeureDebut|date('d/m/Y h:i') }}</td>
                                <td>{{ sortie.dateLimiteInscription|date('d/m/y H:i') }}</td>
                                <td>{{ sortie.users|length }}/{{ sortie.nbInscriptionMax }}</td>
                                <td>{{ sortie.etat.libelle }}</td>
                                <td>
                                    {% if app.user in sortie.users %}
                                        <div class="fond_cross">
                                            <p class="cross">X</p>
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ path('profile_show', {'id': sortie.user.id}) }}">{{ sortie.user.nom }}</a>
                                </td>

                                <td>
                                    <div class="button_action_list">
                                        {# TODO penser à mettre les liens dans les href #}
                                        {% if not (sortie.etat.libelle == '') %}
                                            <a href="{{ path('sortie_details', {'id': sortie.id }) }}">
                                                <button class="button_afficher">Afficher</button>
                                            </a>
                                        {% endif %}
                                        {% if (sortie.etat.libelle == 'Ouverte') and  not (app.user in sortie.users) %}
                                            <a href="{{ path('sortie_inscription', {'id': sortie.id}) }}">
                                                <button class="button_inscrire">S'inscrire</button>
                                            </a>
                                        {% endif %}
                                        {% if (app.user in sortie.users) and not (app.user == sortie.user) %}
                                            <a href="{{ path('sortie_desinscription', {'id': sortie.id}) }}">
                                                <button class="button_desister">Se
                                                    désister
                                                </button>
                                            </a>
                                        {% endif %}
                                        {% if app.user == sortie.user %}
                                            {% if sortie.etat.libelle == 'Créée' %}
                                                <a href="{{ path('sortie_edit', {'id': sortie.id}) }}">
                                                    <button class="button_modifier">Modifier</button>
                                                </a>
                                                <a href="{{ path('sortie_publier', {'id': sortie.id}) }}">
                                                    <button class="button_publier">Publier</button>
                                                </a>
                                            {% endif %}
                                            {% if ( sortie.etat.libelle == 'Ouverte') or (sortie.etat.libelle == 'Clôturée') %}
                                                <a href="{{ path('sortie_cancel', {'id': sortie.id}) }}">
                                                    <button class="button_annuler">Annuler</button>
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>


                </div>
                <div class="addBouton">
                    <a href="{{ path('sortie_new') }}">
                        <button>Créer une sortie</button>
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        const tabla = document.getElementById('table_sortir');
        const cabeceras = tabla.querySelectorAll('thead th');
        const filas = Array.from(tabla.querySelectorAll('tbody tr'));

        cabeceras.forEach(cabecera => {
            cabecera.addEventListener('click', () => {
                const columna = cabecera.getAttribute('data-column');
                const orden = cabecera.classList.contains('asc') ? 'desc' : 'asc';

                // Remover clases de orden en todas las cabeceras
                cabeceras.forEach(c => c.classList.remove('asc', 'desc'));

                // Ordenar las filas
                filas.sort((a, b) => {
                    const valorA = a.querySelector(`td[data-column="${columna}"]`).textContent;
                    const valorB = b.querySelector(`td[data-column="${columna}"]`).textContent;

                    if (orden === 'asc') {
                        return valorA.localeCompare(valorB);
                    } else {
                        return valorB.localeCompare(valorA);
                    }
                });

                // Agregar las filas ordenadas de nuevo a la tabla
                filas.forEach(fila => tabla.querySelector('tbody').appendChild(fila));

                // Agregar clase de orden a la cabecera
                cabecera.classList.add(orden);
            });
        });

    </script>

{% endblock %}
